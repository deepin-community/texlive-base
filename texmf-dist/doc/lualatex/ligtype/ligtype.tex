\documentclass[
ukenglish,%
twoside=false,%
fontsize=10pt,%
bibliography=totoc,%
numbers=autoenddot,%
headings=normalsize,%
overfullrule,%
headings=optiontotoc,%
]
{scrartcl}

\makeatletter
\providecommand\@ix{9.6}
\providecommand\@xi{10.4}
\providecommand\@xiii{13.15}
\def\subfootnotesize{%
    \@setfontsize%
    \subfootnotesize%
    {7.6}{8}%
}
\def\supernormalsize{%
    \@setfontsize%
    \supernormalsize%
    \@xi{12}%
}
\def\subnormalsize{%
    \@setfontsize%
    \subnormalsize%
    \@ix{11}%
}
\def\sublarge{%
    \@setfontsize%
    \sublarge%
    {11.2}{13}%
}
\def\superlarge{%
    \@setfontsize%
    \superlarge%
    \@xiii{16}%
}
\makeatother

\newcommand*{\sectionas}{2.3ex plus .2ex}
\newcommand*{\sectionbs}{-3.5ex plus -1ex minus -.2ex}
\newcommand*{\sectiontbs}{3.6pt}
\newcommand*{\subsectiontbs}{1.2pt}
\newcommand*{\subsectionas}{1.5ex plus .2ex}
\newcommand*{\subsectionbs}{-3.25ex plus -1ex minus -.2ex}
\newcommand*{\subsubsectionas}{\subsectionas}
\newcommand*{\subsubsectionbs}{\subsectionbs}
\newcommand*{\paragraphas}{-1em}
\newcommand*{\paragraphbs}{.8\baselineskip}

\newlength{\tnwsection}
\newlength{\tnwsubsection}
\newlength{\tnwsubsubsection}
\newlength{\tnwparagraph}
\newlength{\tisection}
\newlength{\tisubsection}
\newlength{\tisubsubsection}
\newlength{\tiparagraph}

\setlength{\tnwsection}{1.2em}
\addtolength{\tnwsection}{.6em}
\setlength{\tnwsubsection}{\tnwsection}
\addtolength{\tnwsubsection}{.75em}
\setlength{\tnwsubsubsection}{\tnwsubsection}
\addtolength{\tnwsubsubsection}{.75em}
\setlength{\tnwparagraph}{\tnwsubsubsection}
\addtolength{\tnwparagraph}{.75em}

\setlength{\tisection}{0em}
\setlength{\tisubsection}{\tisection}
\addtolength{\tisubsection}{\tnwsection}
\setlength{\tisubsubsection}{\tisubsection}
\addtolength{\tisubsubsection}{\tnwsubsection}
\setlength{\tiparagraph}{\tisubsubsection}
\addtolength{\tiparagraph}{\tnwsubsubsection}

\RedeclareSectionCommands[%
    tocraggedentrytext=true,%
]%
{section,subsection,subsubsection,paragraph}

\RedeclareSectionCommand[%
    tocindent=\tisection,%
    tocnumwidth=\tnwsection,%
    tocbeforeskip=\sectiontbs,%
    tocentryformat=\supernormalsize\sffamily\bfseries,%
    tocentrynumberformat=\supernormalsize\sffamily\bfseries,%
    tocpagenumberformat=\supernormalsize\sffamily\bfseries%
]%
{section}

\RedeclareSectionCommand[%
    tocindent=\tisubsection,%
    tocnumwidth=\tnwsubsection,%
    tocbeforeskip=\subsectiontbs,%
    tocentryformat=\subnormalsize,%
    tocentrynumberformat=\subnormalsize,%
    tocpagenumberformat=\subnormalsize%
]%
{subsection}

\RedeclareSectionCommand[%
    tocindent=\tisubsubsection,%
    tocnumwidth=\tnwsubsubsection,%
    tocbeforeskip=\sectiontbs%
]%
{subsubsection}

\RedeclareSectionCommand[%
    afterskip=\paragraphas,%
    beforeskip=\paragraphbs,%
    tocindent=\tiparagraph,%
    tocnumwidth=\tnwparagraph,%
    tocbeforeskip=\sectiontbs%
]%
{paragraph}

\linespread{1.1}

\newcommand*{\hs}{\hspace{.45em}}

\usepackage{fontspec}

\directlua{

    fonts.handlers.otf.addfeature {
        name = "onumkern",
        type = "kern",
        data = {
            ["v"] = { ["zero.taboldstyle"] = 80 },
            ["two.taboldstyle"] = { ["zero.taboldstyle"] = 30, ["/"] = 50 },
            ["five.taboldstyle"] = { ["/"] = 20 },
            ["»"] = { ["I"] = 50 },
        },
    }

}

\setmainfont{Tangent}[
    BoldFont = *-Medium,
    ItalicFont = *-Italic,
    Ligatures = {Common, TeX},
    Numbers = OldStyle,
    RawFeature = +onumkern
]

\setsansfont{SegoeUI}[
    BoldFont = seguisb.ttf,
    Ligatures = {Discretionary, TeX},
    Numbers = OldStyle
]

\setmonofont{Consolas}[
    ItalicFont = *-Italic,
    Numbers = OldStyle
]

\newcommand*{\mono}[1]{%
    {\subnormalsize\texttt{#1}}%
}

\newcommand*{\monofn}[1]{%
    {\subfootnotesize\texttt{#1}}%
}

\usepackage{babel}
\usepackage{realscripts}
\usepackage[paper=a4paper,marginratio={2:1,3:4}]{geometry}
\usepackage[noshortf,makemarks]{ligtype}
\usepackage{spacekern}
\usepackage{hyperref}
\usepackage{bookmark}
\usepackage{microtype}

\hypersetup{%
    pdflang=en,%
    unicode=true,%
	pdfborder={0 0 0},%
	bookmarksopen=true,%
    bookmarksopenlevel=0,%
	bookmarksnumbered=true,%
    pdftitle={The ligtype package},
    pdfsubject={Comprehensive ligature suppression functionalities},
    pdfauthor={Thomas Kelkel},
    pdfkeywords={tex, latex, ligatures}
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{.4\baselineskip}

\newcommand*{\q}[1]{%
    ›%
    #1%
    ‹%
}
\newcommand*{\qq}[1]{%
    »%
    #1%
    «%
}

\setlength{\footnotesep}{.8em}

\deffootnote[0em]{0em}{1em}{}

\newcommand*{\fn}[1]{%
    \footnotemark%
    \footnotetext{%
    \textbf{\addfontfeature{Numbers = Lining, BoldFont = Tangent-Bold}\thefootnote}%
        \hs%
        #1%
    }%
}

\newcommand*{\textnote}[1]{%
    {%
        \ttfamily%
        \char174{}%
        #1%
        \char174{}%
    }%
}

\usepackage{luacode}

\begin{luacode}

local FLOOR = math.floor

local function round ( num, dec )
    return FLOOR ( num * 10^dec + 0.5 ) / 10^dec
end

local p_array = {false, false, false, false, false}
local p_counter = 0
local ID = node.id
local NEW = node.new
local COPY = node.copy
local REM = node.remove
local PREV = node.prev
local NEXT = node.next
local TAIL = node.tail
local T_ID = node.traverse_id
local T_GLYPH = node.traverse_glyph
local INS_B = node.insert_before
local GLYPH = ID ( "glyph" )
local GLUE = ID ( "glue" )
local KERN = ID ( "kern" )
local HLIST = ID ( "hlist" )
local SWAPPED = table.swapped
local SUBTYPES = node.subtypes
local SPACESKIP = SWAPPED ( SUBTYPES ("glue") )["spaceskip"]
local WIDTH = round ( tex.sp ( "1.6em" ), 0 )
local ipairs = ipairs
local page_counter = 0
local INS_A = node.insert_after
local p_counter_x = 0
local ATC = luatexbase.add_to_callback

local function make_marks ( head, char, id, array, counter )
    for n in T_GLYPH ( head ) do
        if n.char == char then
            counter = counter + 1
            array[counter] = {false, false, false}
            head = INS_B ( head, n, NEW ( GLYPH ) )
            PREV ( n ).data = id
            local NEXT = n.next
            local inside_counter = 0
            while NEXT.char ~= char do
                inside_counter = inside_counter + 1
                array[counter][inside_counter] = COPY ( NEXT )
                NEXT = NEXT.next
                REM ( head, NEXT.prev )
            end
            head = REM ( head, NEXT )
            head = REM ( head, n )
        end
    end
    return head, array, counter
end

local function mark_notes ( head )
    head, p_array, p_counter = make_marks ( head, 174, 427956, p_array, p_counter )
    return head
end

local function make_margin_notes ( head, id, array, counter )
    for n in T_ID ( HLIST, head ) do
        local first_kern = 0
        local first_width = 0
        for glyph_node in T_GLYPH ( n.head ) do
            if glyph_node.data == id then
                counter = counter + 1
                local tail_node = TAIL ( n.head )
                local glue_node = NEW ( GLUE )
                glue_node.subtype = SPACESKIP
                glue_node.width = WIDTH
                local NEXT
                local switch_counter = 1 -- page_counter
                n.head = INS_A ( n.head, TAIL ( n.head ), glue_node )
                if ( switch_counter % 2 == 0 ) then
                    NEXT = glue_node
                else
                    NEXT = tail_node
                end
                local kern_value = 0
                for _, value in ipairs ( array[counter] ) do
                    if value ~= false then
                        local NUMBER = COPY ( value )
                            n.head = INS_A ( n.head, NEXT, NUMBER)
                            if NEXT.next then
                                NEXT = NEXT.next
                            end
                        if NUMBER.width then
                            kern_value = kern_value - NUMBER.width
                        end
                    end
                end
                local kern_node = NEW ( KERN )
                kern_node.kern = kern_value - glue_node.width
                if switch_counter % 2 ~= 0  then
                    kern_node.kern = kern_node.kern - tex.hsize + first_kern
                    n.head = INS_A ( n.head, tail_node, kern_node )
                end
                if ( switch_counter % 2 == 0 ) and ( first_kern < 0 ) then
                    kern_node.kern = kern_node.kern - first_kern + first_width - kern_value
                    n.head = INS_A ( n.head, tail_node, kern_node )
                end
                first_kern = kern_node.kern
                first_width = kern_value
                head = REM ( head, glyph_node )
            end
        end
    end
    return head, counter
end

local function make_text_notes ( head )
    page_counter = page_counter + 1
    head, p_counter_x = make_margin_notes ( head, 427956, p_array, p_counter_x )
    return head
end

    ATC ( "ligaturing", mark_notes , "mark notes" )
    ATC ( "pre_output_filter", make_text_notes , "count pages" )

\end{luacode}

\flushbottom

\nolig{ligtype}{lig|type}

\begin{document}

\title{The ligtype package\vspace{.25\baselineskip}\\\superlarge{}Comprehensive ligature suppression functionalities}%
\author{\sublarge{}Thomas Kelkel\vspace{-.25\baselineskip}\\\sublarge{}kelkel@emaileon.de\vspace{-.25\baselineskip}}%
\date{\addfontfeature{LetterSpace=2}\sublarge{}2023/07/08\quad{}v0.3}%
\maketitle

\ligtypeoff

\vspace{-2\baselineskip}

\tableofcontents

\vspace{-\baselineskip}

\addvspace{3em}
\hfill\textit{\qq{I don't think you would ever do this in English}}\par
\addvspace{-.25\baselineskip}
\hfill {\small\textbf{David Carlisle}\quad}
\vspace{-2\baselineskip}

\section{Introduction}

The main feature of this package is the selective suppression of typographic ligatures.

There’s already the \mono{selnolig} package by Mico Loretan providing such capability. However, it has some significant shortcomings that render it barely applicable in many use cases. The \mono{ligtype} package steps in to address these deficiencies. The main improvements are:

\paragraph{Kerning}

The \mono{ligtype} package applies kerning for the glyphs of the suppressed ligatures. Both font and user kerning are applied in the usual way.

\paragraph{Short-armed f}

If available, it automatically replaces the f-glyphs of suppressed ligatures with their short-arm variant.

\paragraph{Speed}

It is between ten and twenty times faster on a typical document, thanks to its completely different architecture.\fn{This factor increases with the length of the paragraphs. On a 150-page paragraph, \monofn{ligtype} runs more than a hundred times faster.}

\addvspace{\paragraphbs}

Another, rather minor, difference is that it does not require \mono{fontspec}.

\addvspace{\paragraphbs}

\noindent The \mono{ligtype} package provides built-in suppression of inappropriate ligatures for \textbf{\addfontfeature{BoldFont = Tangent-Bold}German language documents.} (\kern.05emFor this purpose it makes use of the corresponding suppression rules provided by the \mono{selnolig} package, which cover all common f-ligatures\fn{Details can be taken from the \monofn{selnolig} documentation.}.) Using the \mono{nodefault} option and the \mono{\textbackslash{}nolig} and \mono{\textbackslash{}keeplig} macros it can also be used for other languages.

Please note that Lua{\addfontfeature{LetterSpace = 2}\LaTeX} is required to use this package.

Finally, a quick word regarding the code: It is optimized for speed throughout. It would have been much easier to provide a significantly shorter, clearer, more straightforward one. Unfortunately, with this software such code would not have been the fastest one.

\section{Basic usage}

To load the package, simply add the following line to the preamble of the document:

\begin{quote}
    \mono{\textbackslash{}usepackage\{ligtype\}}
\end{quote}

If the glyphs forming the ligatures are already properly kerned and a German language document is typeset, loading the package without any options should be sufficient for most use cases.

However, most of the time it will be the case that the corresponding glyphs have to be kerned first. For this task, the \mono{kerntest} option is extremely helpful.

\section{Package options}

Options can be loaded by adding them comma separated within square brackets:

\begin{quote}
    \mono{\textbackslash{}usepackage[\textit{<option1>,<option2>,…}]\{ligtype\}}
\end{quote}

\addcontentsline{toc}{subsection}{kerntest}

\textnote{kerntest}This option prints all glyph combinations that comprise the ligatures \mono{ligtype} is looking for in Regular, Italic, Bold and Italic Bold for both the Roman and the Sans font on the last page of the document. This gives you an overview of all kerning pairs that are relevant when breaking ligatures, and you can inspect the kerning values accordingly.

\addcontentsline{toc}{subsection}{liglist}

\textnote{liglist}Prints, both in the output and in an external file \mono{[filename].lig,} a sorted list of all kept and broken ligatures.

White- and blacklists can be used in conjunction with this feature. For this \mono{lig-whitelist.txt} and \mono{lig-blacklist.txt} must be provided in the document path. In the whitelist the ligatures to be broken are listed in the blacklist the ligatures to be kept. According to the formatting in the output file, the breaking points are marked with a vertical bar in the whitelist and with a centered period in the blacklist.

\addcontentsline{toc}{subsection}{makemarks}

\textnote{makemarks}Marks each point where a ligature was suppressed with a blue triangle below the baseline.

\addcontentsline{toc}{subsection}{noshortf}

\textnote{noshortf}Various use cases are conceivable with this option.

It is primarily intended to suppress the use of short-armed f if they are not desired.

In addition, it may be useful to load this option when using fonts that do not offer short-armed f, since there is a small gain in speed if \mono{ligtype} does not look for them.

Finally, this option could be used to prevent \qq{false positives}. (Even though such are not known to occur.)

\addcontentsline{toc}{subsection}{allshortf}

\textnote{allshortf}In some cases it may be desirable to use short-armed f without having different f-glyphs in the document. This option can be used for such purpose, since it replaces all long-armed f with their short-arm variant (if available).

This option has priority over the \mono{noshortf} option, i.\,e. if both are loaded, \mono{allshortf} is applied.

\addcontentsline{toc}{subsection}{nodefault}

\textnote{nodefault}Disables the built-in (German language) suppression rules. With this option and the \mono{\textbackslash{}nolig} and \mono{\textbackslash{}keeplig} macros, \mono{ligtype} can be used for other languages.

\section{Macros}

\addcontentsline{toc}{subsection}{nolig}

\addcontentsline{toc}{subsection}{keeplig}

\textnote{\textbackslash{}nolig}The first macro defines a rule for suppressing ligatures, the second one for keeping them. Both macros take two arguments.\textnote{\textbackslash{}keeplig} The first one specifies the string to search for. In the second, a marker of the breaking point is added to this string using a vertical bar.\fn{The architecture of the \monofn{ligtype} package differs quite significantly from that of the \monofn{selnolig} package. To allow current users of \monofn{selnolig} to continue using existing macros for creating suppression rules as far as possible without changes, the syntax has been largely adopted. For the \monofn{\textbackslash{}nolig} macro it is identical. However, in contrast to the \monofn{selnolig} syntax, the breakpoint must be specified as a second argument for the \monofn{\textbackslash{}keeplig} macros, since \monofn{ligtype} requires this for every rule application.} For example:

\begin{quote}
    \mono{\textbackslash{}nolig\{flich\}\{f|lich\}}\\
    \mono{\textbackslash{}keeplig\{flicht\}\{f|licht\}}
\end{quote}

A list of alternatives that can be located at the end of the string can be specified within square brackets:

\begin{quote}
    \mono{\textbackslash{}nolig\{Auff[aeiloruyäöü]\}\{Auf|f\}}
\end{quote}

It is important to note that macros are processed in the order in which they are defined, which means that strings defined later have priority over strings defined earlier. Accordingly, strings defined later should not be included in strings defined earlier, otherwise the earlier ones will have no effect.

\addcontentsline{toc}{subsection}{ligtypeon}

\addcontentsline{toc}{subsection}{ligtypeoff}

\textnote{\textbackslash{}ligtypeon}With the help of these macros the features of the \mono{ligtype} package can be switched on and off within the document.\textnote{\textbackslash{}ligtypeoff}

\section{Acknowledgements}

The \mono{ligtype} package makes use of the German language ligature suppression rules of the \mono{selnolig} package by Mico Loretan. The \mono{selnolig} package can be downloaded at

\begin{quote}
    \mono{https://www.ctan.org/pkg/selnolig}
\end{quote}

and may be distributed and/or modified under the conditions of the LaTeX Project Public License.

Please see the \qq{License and acknowledgments} section of the \mono{selnolig} documentation to learn about all the people who contributed to the creation of the suppression rules.

In general, the truly excellent \mono{selnolig} documentation is highly recommended for further information on the subject of this package.

\section{License}

This package is copyright © 2022\kern.1em–\kern.1em2023 Thomas Kelkel. It may be distributed and/or modified under the conditions of the LaTeX Project Public License, either version 1.3c of this license or (at your option) any later version. This work has the LPPL maintenance status \qq{author maintained}.

\end{document}